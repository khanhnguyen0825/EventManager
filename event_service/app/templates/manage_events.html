{% extends 'base.html' %} {% block content %}
<div class="container mt-4 p-4 page_background">
  <h3 class="text-center text-danger">Danh sách sự kiện hiện có</h3>

  {% set total_events = customer_events | selectattr('events') | map('length') |
  sum %} {% if total_events > 0 %}
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Tên khách hàng</th>
        <th>Email khách hàng</th>
        <th>Thông tin sự kiện</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for customer_event in customer_events %} {% set customer =
      customer_event.customer %} {% set events = customer_event.events %} {% set
      total = events|length %} {% if total > 0 %} {% for event in events %}
      <tr>
        {% if loop.index == 1 %}
        <td rowspan="{{ total }}">{{ customer.name }}</td>
        <td rowspan="{{ total }}">{{ customer.email }}</td>
        {% endif %}
        <td>
          <strong>{{ event.name }}</strong><br />
          {{ event.description | replace('\n', '<br />') | safe }}<br />
          <span class="badge bg-info text-dark"
            >Tổng vé: {{ event.total_tickets_display }}</span
          >
          <span class="badge bg-success text-light"
            >Còn lại: {{ event.available_tickets_display }}</span
          >
        </td>
        <td class="text-center">
          <div>
            <a
              href="http://localhost:5003/reports/write/{{ event.id }}"
              class="btn btn-sm btn-success border-button"
            >
              <i class="fas fa-check"></i> Hoàn thành
            </a>
            <button
              type="button"
              class="btn btn-sm btn-danger border-button ml-2"
              data-toggle="modal"
              data-target="#deleteModal{{ event.id }}"
            >
              <i class="fas fa-trash"></i> Xóa
            </button>
          </div>

          <!-- Modal Xác nhận xóa -->
          <div
            class="modal fade"
            id="deleteModal{{ event.id }}"
            tabindex="-1"
            role="dialog"
          >
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-danger"></i> Xác
                    nhận xóa
                  </h5>
                  <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p>Bạn có chắc chắn muốn xóa sự kiện này?</p>
                  <strong>{{ event.name }}</strong><br />
                  <small class="text-muted"
                    >Thao tác này không thể hoàn tác.</small
                  >
                </div>
                <div class="modal-footer">
                  <form
                    action="{{ url_for('event.delete_event', event_id=event.id) }}"
                    method="POST"
                  >
                    <button
                      type="button"
                      class="btn btn-secondary border-button"
                      data-dismiss="modal"
                    >
                      <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-danger border-button">
                      <i class="fas fa-trash"></i> Xóa
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %} {% else %}
      <tr>
        <td>{{ customer.name }}</td>
        <td>{{ customer.email }}</td>
        <td colspan="2" class="text-muted text-center">
          Khách hàng chưa có sự kiện
        </td>
      </tr>
      {% endif %} {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="text-center mt-5">
    <img
      src="{{ url_for('static', filename='img/done.svg') }}"
      width="220"
      alt="All done"
    />
    <h5 class="mt-3 text-muted">Tất cả các sự kiện đã được hoàn thành!</h5>
    <a href="http://localhost:5001/customers/">Quản lý khách hàng</a>
  </div>
  {% endif %}

  <div class="d-flex justify-content-between mt-4">
    <a
      href="http://localhost:5001/customers/dashboard?admin=true"
      class="btn btn-secondary border-button"
    >
      <i class="fa fa-arrow-left"></i> &nbsp;Quay lại trang quản lý
    </a>
    <a
      href="http://localhost:5003/reports/completed"
      class="btn btn-primary border-button"
    >
      <i class="fa fa-arrow-right"></i> &nbsp;Danh sách sự kiện đã hoàn thành
    </a>
    <a
      href="http://localhost:5002/events/viewer"
      class="btn btn-success border-button"
    >
      <i class="fa fa-arrow-right"></i> &nbsp;Danh sách vé đã đặt
    </a>
  </div>
</div>
{% endblock %}
